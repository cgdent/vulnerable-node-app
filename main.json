AWSTemplateFormatVersion: "2010-09-09"
Metadata:
    Generator: "former2"
Description: ""
Resources:
    EC2Instance:
        Type: "AWS::EC2::Instance"
        Properties:
            ImageId: "ami-072276e586375df1d"
            InstanceType: "t2.micro"
            KeyName: "My APJ SE Sydney Key Pair"
            AvailabilityZone: !GetAtt EC2Instance3.AvailabilityZone
            Tenancy: "default"
            SubnetId: "subnet-01a44f8b6249180b3"
            EbsOptimized: false
            SecurityGroupIds: 
              - "sg-002ec7c65880d96c1"
            SourceDestCheck: true
            BlockDeviceMappings: 
              - 
                DeviceName: "/dev/xvda"
                Ebs: 
                    Encrypted: false
                    VolumeSize: 8
                    SnapshotId: "snap-0b671f76f5e0c8971"
                    VolumeType: "gp2"
                    DeleteOnTermination: true
            Tags: 
              - 
                Key: "Name"
                Value: "MyMongoDBServer"
            HibernationOptions: 
                Configured: false
            EnclaveOptions: 
                Enabled: false

    EC2Instance2:
        Type: "AWS::EC2::Instance"
        Properties:
            ImageId: "ami-0b334634a6fabcc4a"
            InstanceType: "t3.medium"
            AvailabilityZone: !Sub "${AWS::Region}c"
            Tenancy: "default"
            SubnetId: "subnet-0d48b149391be9a13"
            EbsOptimized: false
            SecurityGroupIds: 
              - "sg-0c8edf1a6ab4431e7"
              - "sg-0c8edf1a6ab4431e7"
            SourceDestCheck: true
            BlockDeviceMappings: 
              - 
                DeviceName: "/dev/xvda"
                Ebs: 
                    Encrypted: false
                    VolumeSize: 80
                    SnapshotId: "snap-073d5be404a5028e1"
                    VolumeType: "gp3"
                    DeleteOnTermination: true
            UserData: "TUlNRS1WZXJzaW9uOiAxLjAKQ29udGVudC1UeXBlOiBtdWx0aXBhcnQvbWl4ZWQ7IGJvdW5kYXJ5PSIvLyIKCi0tLy8KQ29udGVudC1UeXBlOiB0ZXh0L3gtc2hlbGxzY3JpcHQ7IGNoYXJzZXQ9InVzLWFzY2lpIgojIS9iaW4vYmFzaApzZXQgLWV4CkI2NF9DTFVTVEVSX0NBPUxTMHRMUzFDUlVkSlRpQkRSVkpVU1VaSlEwRlVSUzB0TFMwdENrMUpTVU12YWtORFFXVmhaMEYzU1VKQlowbENRVVJCVGtKbmEzRm9hMmxIT1hjd1FrRlJjMFpCUkVGV1RWSk5kMFZSV1VSV1VWRkVSWGR3Y21SWFNtd0tZMjAxYkdSSFZucE5RalJZUkZSSmVrMUVWWGhPUkVFeFRWUnJlVTVXYjFoRVZFMTZUVVJWZUUxVVFURk5WR3Q1VGxadmQwWlVSVlJOUWtWSFFURlZSUXBCZUUxTFlUTldhVnBZU25WYVdGSnNZM3BEUTBGVFNYZEVVVmxLUzI5YVNXaDJZMDVCVVVWQ1FsRkJSR2RuUlZCQlJFTkRRVkZ2UTJkblJVSkJTeTl1Q25CbmVrMURiV3haVDFndlp6RkRWamMxVUV0dlJqaEJUMWQ1Y3pkNU5rUTVlbGhaYzFZMlJtWnVaRWx1Vm5GVVdqVnhNR0pzV0VSSmEyUTFPRVpRTVhRS05GZHRSbkJRVmpaUU5TOXJhMWMxVG5GaE9UUnphV0Z4V1dKSWRWSmxhVkpxVURVdk1sQlFkMk54YlVWdGRHRnNORGh4WVdwUFoxcFJTMHBJWjA1NlpncEVXV2xCV1hoM1R6aHJhMmRNYmtkdVFYVkljRnBVUWpCWGN6UkNSekUzU0hORFVrRm9iazVLTjJOYVRUTnFVbWczVW14eE0yVnNjRGQzZEROelRsTnRDa3RaTlZSYVZGSXdTVk4yT0dkS1pFcFVZMk4zVGpsUVExZExXRE5aVjNKb1NqRXdZakEwUVZkU1lYVkhkbkpPVkZNeE9FTkJPRWRWYW5oamRHZFNXbFVLYVdSR01VY3ZSMlZFYXl0U1F6SkJkVnBZWlN0dGFWTlZhRWh1Y0U5WWJXZHRNR3B1VkdSc1FqQnZlV0ZWTDFrMFdIcFJURXB4Tnl0WE5GRnZhRTluT1FwdldGcG1PV2M1V2pORE4wVTBOVlpSZW5KTlEwRjNSVUZCWVU1YVRVWmpkMFJuV1VSV1VqQlFRVkZJTDBKQlVVUkJaMHRyVFVFNFIwRXhWV1JGZDBWQ0NpOTNVVVpOUVUxQ1FXWTRkMGhSV1VSV1VqQlBRa0paUlVaTUsyNXBXVXB1ZWxoNFVVRmhSVkp2TlZoeFZrVkljekp0ZEdwTlFsVkhRVEZWWkVWUlVVOEtUVUY1UTBOdGRERlpiVlo1WW0xV01GcFlUWGRFVVZsS1MyOWFTV2gyWTA1QlVVVk1RbEZCUkdkblJVSkJTV2h6WjB3ME5WZHVaalpTVjBaUk9UaEpjQXA2YUZOd1RGWk1hbFpETlhWbE9HdHpaVmhoZWpaVE5sZzRjM2RSYXpoQmJYUm9NRmhoTlhVeVFsZFdRaXRoUlRBME5WcHNXQ3RsZW05U1NWQkdaM1ZyQ21kbVZ6bDJNRWxaTmxSNGNTOTVUbXhHU2pRclNEaHpVek55TURrM1NVeEdTbGhESzNSdFYyZG5hbk5MUTJ4M1VtZzVabEZITWtnd1NtNXdiVmQ0YlZNS2JHaEpjRkZ6VlVKbFYybExUMUEyUkVwblpGRklVRlIzV0hWVVNuVklWRU0zVTJOVVNWcFlaM2x2WW1oeFJYWnpaM0pJUXpObFlqQnZNbGhFUlcweFF3cFpUVGQ2TVZGVFFXOU9aWFZDZVdJd1MyNW5jRmRFYTBZMVlUQnBOMlp3YW05bVozVTVjMlkyZGxSek1XNVhNVGhCY2tjM1lXbzVaMlV3V21SeFMwUkRDbWxrUTBKR1p6VkZjV2xTVVZkb1UxUTVia0YwV1UxWVRHUnNka0pEZUhjMVREQmpjSFkyZEdwTmRVSjRlbGxFU1hwbFYweEdVa0UxUzFkdVNYTklNV29LUzFWclBRb3RMUzB0TFVWT1JDQkRSVkpVU1VaSlEwRlVSUzB0TFMwdENnPT0KQVBJX1NFUlZFUl9VUkw9aHR0cHM6Ly83Rjk0QkYzRjVBQ0IwNUJGNTAyNEZBNkY0QzZBRjEzNi5ncjcuYXAtc291dGhlYXN0LTIuZWtzLmFtYXpvbmF3cy5jb20KSzhTX0NMVVNURVJfRE5TX0lQPTEwLjEwMC4wLjEwCi9ldGMvZWtzL2Jvb3RzdHJhcC5zaCBjcmFpZy1la3MgLS1rdWJlbGV0LWV4dHJhLWFyZ3MgJy0tbm9kZS1sYWJlbHM9ZWtzLmFtYXpvbmF3cy5jb20vc291cmNlTGF1bmNoVGVtcGxhdGVWZXJzaW9uPTEsYWxwaGEuZWtzY3RsLmlvL2NsdXN0ZXItbmFtZT1jcmFpZy1la3MsYWxwaGEuZWtzY3RsLmlvL25vZGVncm91cC1uYW1lPXN0YW5kYXJkLXdvcmtlcnMsZWtzLmFtYXpvbmF3cy5jb20vbm9kZWdyb3VwLWltYWdlPWFtaS0wYjMzNDYzNGE2ZmFiY2M0YSxla3MuYW1hem9uYXdzLmNvbS9jYXBhY2l0eVR5cGU9T05fREVNQU5ELGVrcy5hbWF6b25hd3MuY29tL25vZGVncm91cD1zdGFuZGFyZC13b3JrZXJzLGVrcy5hbWF6b25hd3MuY29tL3NvdXJjZUxhdW5jaFRlbXBsYXRlSWQ9bHQtMDQ4YjBmNjEzOWY4NGRhMzIgLS1tYXgtcG9kcz0xNycgLS1iNjQtY2x1c3Rlci1jYSAkQjY0X0NMVVNURVJfQ0EgLS1hcGlzZXJ2ZXItZW5kcG9pbnQgJEFQSV9TRVJWRVJfVVJMIC0tZG5zLWNsdXN0ZXItaXAgJEs4U19DTFVTVEVSX0ROU19JUCAtLXVzZS1tYXgtcG9kcyBmYWxzZQoKLS0vLy0t"
            IamInstanceProfile: "eks-dcc40c79-e265-93be-8fea-c4659b8a140c"
            Tags: 
              - 
                Key: "alpha.eksctl.io/nodegroup-type"
                Value: "managed"
              - 
                Key: "alpha.eksctl.io/nodegroup-name"
                Value: "standard-workers"
              - 
                Key: "k8s.io/cluster-autoscaler/enabled"
                Value: "true"
              - 
                Key: "k8s.io/cluster-autoscaler/craig-eks"
                Value: "owned"
              - 
                Key: "kubernetes.io/cluster/craig-eks"
                Value: "owned"
              - 
                Key: "eks:cluster-name"
                Value: "craig-eks"
              - 
                Key: "eks:nodegroup-name"
                Value: "standard-workers"
              - 
                Key: "Name"
                Value: "craig-eks-standard-workers-Node"
            HibernationOptions: 
                Configured: false
            CpuOptions: 
                CoreCount: 1
                ThreadsPerCore: 2
            EnclaveOptions: 
                Enabled: false

    EC2Instance3:
        Type: "AWS::EC2::Instance"
        Properties:
            ImageId: "ami-0b334634a6fabcc4a"
            InstanceType: "t3.medium"
            AvailabilityZone: !Sub "${AWS::Region}a"
            Tenancy: "default"
            SubnetId: "subnet-082449d215e151f66"
            EbsOptimized: false
            SecurityGroupIds: 
              - "sg-0c8edf1a6ab4431e7"
              - "sg-0c8edf1a6ab4431e7"
            SourceDestCheck: true
            BlockDeviceMappings: 
              - 
                DeviceName: "/dev/xvda"
                Ebs: 
                    Encrypted: false
                    VolumeSize: 80
                    SnapshotId: "snap-073d5be404a5028e1"
                    VolumeType: "gp3"
                    DeleteOnTermination: true
            UserData: "TUlNRS1WZXJzaW9uOiAxLjAKQ29udGVudC1UeXBlOiBtdWx0aXBhcnQvbWl4ZWQ7IGJvdW5kYXJ5PSIvLyIKCi0tLy8KQ29udGVudC1UeXBlOiB0ZXh0L3gtc2hlbGxzY3JpcHQ7IGNoYXJzZXQ9InVzLWFzY2lpIgojIS9iaW4vYmFzaApzZXQgLWV4CkI2NF9DTFVTVEVSX0NBPUxTMHRMUzFDUlVkSlRpQkRSVkpVU1VaSlEwRlVSUzB0TFMwdENrMUpTVU12YWtORFFXVmhaMEYzU1VKQlowbENRVVJCVGtKbmEzRm9hMmxIT1hjd1FrRlJjMFpCUkVGV1RWSk5kMFZSV1VSV1VWRkVSWGR3Y21SWFNtd0tZMjAxYkdSSFZucE5RalJZUkZSSmVrMUVWWGhPUkVFeFRWUnJlVTVXYjFoRVZFMTZUVVJWZUUxVVFURk5WR3Q1VGxadmQwWlVSVlJOUWtWSFFURlZSUXBCZUUxTFlUTldhVnBZU25WYVdGSnNZM3BEUTBGVFNYZEVVVmxLUzI5YVNXaDJZMDVCVVVWQ1FsRkJSR2RuUlZCQlJFTkRRVkZ2UTJkblJVSkJTeTl1Q25CbmVrMURiV3haVDFndlp6RkRWamMxVUV0dlJqaEJUMWQ1Y3pkNU5rUTVlbGhaYzFZMlJtWnVaRWx1Vm5GVVdqVnhNR0pzV0VSSmEyUTFPRVpRTVhRS05GZHRSbkJRVmpaUU5TOXJhMWMxVG5GaE9UUnphV0Z4V1dKSWRWSmxhVkpxVURVdk1sQlFkMk54YlVWdGRHRnNORGh4WVdwUFoxcFJTMHBJWjA1NlpncEVXV2xCV1hoM1R6aHJhMmRNYmtkdVFYVkljRnBVUWpCWGN6UkNSekUzU0hORFVrRm9iazVLTjJOYVRUTnFVbWczVW14eE0yVnNjRGQzZEROelRsTnRDa3RaTlZSYVZGSXdTVk4yT0dkS1pFcFVZMk4zVGpsUVExZExXRE5aVjNKb1NqRXdZakEwUVZkU1lYVkhkbkpPVkZNeE9FTkJPRWRWYW5oamRHZFNXbFVLYVdSR01VY3ZSMlZFYXl0U1F6SkJkVnBZWlN0dGFWTlZhRWh1Y0U5WWJXZHRNR3B1VkdSc1FqQnZlV0ZWTDFrMFdIcFJURXB4Tnl0WE5GRnZhRTluT1FwdldGcG1PV2M1V2pORE4wVTBOVlpSZW5KTlEwRjNSVUZCWVU1YVRVWmpkMFJuV1VSV1VqQlFRVkZJTDBKQlVVUkJaMHRyVFVFNFIwRXhWV1JGZDBWQ0NpOTNVVVpOUVUxQ1FXWTRkMGhSV1VSV1VqQlBRa0paUlVaTUsyNXBXVXB1ZWxoNFVVRmhSVkp2TlZoeFZrVkljekp0ZEdwTlFsVkhRVEZWWkVWUlVVOEtUVUY1UTBOdGRERlpiVlo1WW0xV01GcFlUWGRFVVZsS1MyOWFTV2gyWTA1QlVVVk1RbEZCUkdkblJVSkJTV2h6WjB3ME5WZHVaalpTVjBaUk9UaEpjQXA2YUZOd1RGWk1hbFpETlhWbE9HdHpaVmhoZWpaVE5sZzRjM2RSYXpoQmJYUm9NRmhoTlhVeVFsZFdRaXRoUlRBME5WcHNXQ3RsZW05U1NWQkdaM1ZyQ21kbVZ6bDJNRWxaTmxSNGNTOTVUbXhHU2pRclNEaHpVek55TURrM1NVeEdTbGhESzNSdFYyZG5hbk5MUTJ4M1VtZzVabEZITWtnd1NtNXdiVmQ0YlZNS2JHaEpjRkZ6VlVKbFYybExUMUEyUkVwblpGRklVRlIzV0hWVVNuVklWRU0zVTJOVVNWcFlaM2x2WW1oeFJYWnpaM0pJUXpObFlqQnZNbGhFUlcweFF3cFpUVGQ2TVZGVFFXOU9aWFZDZVdJd1MyNW5jRmRFYTBZMVlUQnBOMlp3YW05bVozVTVjMlkyZGxSek1XNVhNVGhCY2tjM1lXbzVaMlV3V21SeFMwUkRDbWxrUTBKR1p6VkZjV2xTVVZkb1UxUTVia0YwV1UxWVRHUnNka0pEZUhjMVREQmpjSFkyZEdwTmRVSjRlbGxFU1hwbFYweEdVa0UxUzFkdVNYTklNV29LUzFWclBRb3RMUzB0TFVWT1JDQkRSVkpVU1VaSlEwRlVSUzB0TFMwdENnPT0KQVBJX1NFUlZFUl9VUkw9aHR0cHM6Ly83Rjk0QkYzRjVBQ0IwNUJGNTAyNEZBNkY0QzZBRjEzNi5ncjcuYXAtc291dGhlYXN0LTIuZWtzLmFtYXpvbmF3cy5jb20KSzhTX0NMVVNURVJfRE5TX0lQPTEwLjEwMC4wLjEwCi9ldGMvZWtzL2Jvb3RzdHJhcC5zaCBjcmFpZy1la3MgLS1rdWJlbGV0LWV4dHJhLWFyZ3MgJy0tbm9kZS1sYWJlbHM9ZWtzLmFtYXpvbmF3cy5jb20vc291cmNlTGF1bmNoVGVtcGxhdGVWZXJzaW9uPTEsYWxwaGEuZWtzY3RsLmlvL2NsdXN0ZXItbmFtZT1jcmFpZy1la3MsYWxwaGEuZWtzY3RsLmlvL25vZGVncm91cC1uYW1lPXN0YW5kYXJkLXdvcmtlcnMsZWtzLmFtYXpvbmF3cy5jb20vbm9kZWdyb3VwLWltYWdlPWFtaS0wYjMzNDYzNGE2ZmFiY2M0YSxla3MuYW1hem9uYXdzLmNvbS9jYXBhY2l0eVR5cGU9T05fREVNQU5ELGVrcy5hbWF6b25hd3MuY29tL25vZGVncm91cD1zdGFuZGFyZC13b3JrZXJzLGVrcy5hbWF6b25hd3MuY29tL3NvdXJjZUxhdW5jaFRlbXBsYXRlSWQ9bHQtMDQ4YjBmNjEzOWY4NGRhMzIgLS1tYXgtcG9kcz0xNycgLS1iNjQtY2x1c3Rlci1jYSAkQjY0X0NMVVNURVJfQ0EgLS1hcGlzZXJ2ZXItZW5kcG9pbnQgJEFQSV9TRVJWRVJfVVJMIC0tZG5zLWNsdXN0ZXItaXAgJEs4U19DTFVTVEVSX0ROU19JUCAtLXVzZS1tYXgtcG9kcyBmYWxzZQoKLS0vLy0t"
            IamInstanceProfile: "eks-dcc40c79-e265-93be-8fea-c4659b8a140c"
            Tags: 
              - 
                Key: "alpha.eksctl.io/nodegroup-type"
                Value: "managed"
              - 
                Key: "k8s.io/cluster-autoscaler/craig-eks"
                Value: "owned"
              - 
                Key: "k8s.io/cluster-autoscaler/enabled"
                Value: "true"
              - 
                Key: "alpha.eksctl.io/nodegroup-name"
                Value: "standard-workers"
              - 
                Key: "Name"
                Value: "craig-eks-standard-workers-Node"
              - 
                Key: "kubernetes.io/cluster/craig-eks"
                Value: "owned"
              - 
                Key: "eks:cluster-name"
                Value: "craig-eks"
              - 
                Key: "eks:nodegroup-name"
                Value: "standard-workers"
            HibernationOptions: 
                Configured: false
            CpuOptions: 
                CoreCount: 1
                ThreadsPerCore: 2
            EnclaveOptions: 
                Enabled: false

    ECRRepository:
        Type: "AWS::ECR::Repository"
        Properties:
            RepositoryName: "vuln-node"
            LifecyclePolicy: 
                RegistryId: !Ref AWS::AccountId

    EKSCluster:
        Type: "AWS::EKS::Cluster"
        Properties:
            Name: "craig-eks"
            RoleArn: !Sub "arn:aws:iam::${AWS::AccountId}:role/eksctl-craig-eks-cluster-ServiceRole-1RB8ZVCN1RS0L"
            Version: "1.25"
            ResourcesVpcConfig: 
                SecurityGroupIds: 
                  - "sg-0efa165528cfa2b91"
                SubnetIds: 
                  - "subnet-005efa804d7c15667"
                  - "subnet-06c64e00c77bc38e0"
                  - "subnet-09883a3444e25c8b5"
                  - "subnet-02bebf959e12963a5"
                  - "subnet-0d48b149391be9a13"
                  - "subnet-082449d215e151f66"
            KubernetesNetworkConfig: 
                ServiceIpv4Cidr: "10.100.0.0/16"

    S3Bucket:
        Type: "AWS::S3::Bucket"
        Properties:
            BucketName: "mongodb-backups-tech-exercise"
            BucketEncryption: 
                ServerSideEncryptionConfiguration: 
                  - 
                    ServerSideEncryptionByDefault: 
                        SSEAlgorithm: "AES256"
                    BucketKeyEnabled: false

    EC2VPC:
        Type: "AWS::EC2::VPC"
        Properties:
            CidrBlock: "192.168.0.0/16"
            EnableDnsSupport: true
            EnableDnsHostnames: true
            InstanceTenancy: "default"
            Tags: 
              - 
                Key: "eksctl.cluster.k8s.io/v1alpha1/cluster-name"
                Value: "craig-eks"
              - 
                Key: "alpha.eksctl.io/eksctl-version"
                Value: "0.139.0"
              - 
                Key: "alpha.eksctl.io/cluster-name"
                Value: "craig-eks"
              - 
                Key: "alpha.eksctl.io/cluster-oidc-enabled"
                Value: "false"
              - 
                Key: "Name"
                Value: "eksctl-craig-eks-cluster/VPC"

    EC2VPC2:
        Type: "AWS::EC2::VPC"
        Properties:
            CidrBlock: "10.0.0.0/16"
            EnableDnsSupport: true
            EnableDnsHostnames: true
            InstanceTenancy: "default"
            Tags: 
              - 
                Key: "Name"
                Value: "TechExercise-vpc"

